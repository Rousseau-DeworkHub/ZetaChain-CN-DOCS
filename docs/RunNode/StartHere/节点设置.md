# 设置节点

|标题|描述|
|:-|:-|
|设置节点|在本指南中，我们将设置一个 ZetaChain 主网 Beta 节点。对于测试网节点，请遵循相同的说明，但将某些值（如链 ID 和种子节点）替换为相应表格中提供的值。|

## 安装 ZetaChain 节点二进制文件

首先，下载二进制文件并赋予其可执行权限。请确保将 `VERSION` 替换为[治理软件升级提案](https://www.google.com/search?q=/reference/tools/proposals)中通过的最新版本，并将平台 (`-linux-amd64`) 替换为您需要的平台。

```bash
sudo wget https://github.com/zeta-chain/node/releases/download/VERSION/zetacored-linux-amd64 -O /usr/local/bin/zetacored &&\
sudo chmod a+x /usr/local/bin/zetacored
```

请在 GitHub 查看[关于发布的更多信息](https://github.com/zeta-chain/node/releases)。

检查您是否安装了正确版本的 `zetacored`：

```bash
zetacored version
```

-----

## 创建非 Root 用户账户

我们建议使用用户账户而非 root 账户运行 ZetaChain 二进制文件。

```bash
sudo useradd -m -s /bin/bash zetachain
```

-----

## 初始化数据目录

| 网络   | 链 ID         |
| :----- | :------------ |
| 主网   | zetachain_7000-1 |
| 测试网 | athens_7001-1    |

```bash
sudo -u zetachain zetacored init MONIKER --chain-id zetachain_7000-1
```

将 `MONIKER` 替换为您节点的名称。默认情况下，节点将在 `$HOME/.zetacored` 中初始化，但您可以使用 `--home` 标志自定义此路径。

-----

## 获取配置文件

| 网络   | 配置文件                                                       |
| :----- | :------------------------------------------------------------- |
| 主网   | [https://github.com/zeta-chain/network-config/tree/main/mainnet](https://github.com/zeta-chain/network-config/tree/main/mainnet) |
| 测试网 | [https://github.com/zeta-chain/network-config/tree/main/athens3](https://github.com/zeta-chain/network-config/tree/main/athens3) |

获取配置文件并将其保存在数据目录中：

```bash
sudo -u zetachain wget https://raw.githubusercontent.com/zeta-chain/network-config/main/mainnet/genesis.json -O /home/zetachain/.zetacored/config/genesis.json &&\
sudo -u zetachain wget https://raw.githubusercontent.com/zeta-chain/network-config/main/mainnet/client.toml -O /home/zetachain/.zetacored/config/client.toml &&\
sudo -u zetachain wget https://raw.githubusercontent.com/zeta-chain/network-config/main/mainnet/config.toml -O /home/zetachain/.zetacored/config/config.toml &&\
sudo -u zetachain wget https://raw.githubusercontent.com/zeta-chain/network-config/main/mainnet/app.toml -O /home/zetachain/.zetacored/config/app.toml
```

## 修改配置文件

尽管您在上一步获取的配置文件已包含所有节点通用的必需值，但您仍需要根据您的节点进行一些特定的调整。

如果您的机器有外部 IPv4 地址，可以在终端中运行以下命令获取：

```bash
curl -4 icanhazip.com
```

如果您有 IPv6 地址，也可以将其用作外部地址。

将 `moniker` 和 `external_address` 替换为正确的值。

```toml filename="~/.zetacored/config/config.toml"
moniker = "{MONIKER}"
external_address = "{YOUR_EXTERNAL_IP_ADDRESS_HERE}:26656"
```

## 设置打开文件和进程数量限制

为了更好地管理节点资源，我们建议设置最大打开文件描述符数 (`nofile`) 和最大进程数 (`nproc`) 的限制。

编辑 `/etc/security/limits.conf` 文件，包含或修改以下参数：

```text
* soft    nproc   262144
* hard    nproc   262144
* soft    nofile  262144
* hard    nofile  262144
```

编辑 `/etc/sysctl.conf` 文件，包含以下内容：

```text
fs.file-max=262144
```

## 安装 Cosmovisor

根据 [Cosmos 文档](https://docs.cosmos.network/v0.47/build/tooling/cosmovisor)：

> Cosmovisor 是 Cosmos SDK 应用程序二进制文件的进程管理器，它可以在链升级时自动切换应用程序二进制文件。它会轮询由 x/upgrade 模块在升级高度创建的 `upgrade-info.json` 文件，然后可以自动下载新的二进制文件，停止当前的二进制文件，从旧的二进制文件切换到新的，最后用新的二进制文件重新启动节点。

### 从源码安装

```bash
go install cosmossdk.io/tools/cosmovisor/cmd/cosmovisor@v1.7.1
mv $(go env GOPATH)/bin/cosmovisor /usr/local/bin/cosmovisor
```

### 从预编译二进制文件安装

从 [Cosmovisor v1.7.1 发布页面](https://github.com/cosmos/cosmos-sdk/releases/tag/cosmovisor%2Fv1.7.1) 下载正确的二进制文件。例如：

```bash
wget https://github.com/cosmos/cosmos-sdk/releases/download/cosmovisor%2Fv1.7.1/cosmovisor-v1.7.1-linux-amd64.tar.gz
tar xf cosmovisor-v1.7.1-linux-amd64.tar.gz &&\
chmod a+x cosmovisor &&\
sudo mv cosmovisor /usr/local/bin
```

-----

## 设置 Cosmovisor

### 创建 `cosmovisor` 目录

```bash
sudo -u zetachain mkdir -p /home/zetachain/.zetacored/cosmovisor/genesis/bin &&\
sudo -u zetachain mkdir -p /home/zetachain/.zetacored/cosmovisor/upgrades
```

### 安装当前的 `zetacored` 二进制文件

找到在[设置](./setup)中指定的当前 `zetacored` 二进制文件。将其放置在 `/home/zetachain/.zetacored/cosmovisor/genesis/bin` 目录下，而不是 `$PATH` 中。

```bash
sudo -u zetachain cp /usr/local/bin/zetacored /home/zetachain/.zetacored/cosmovisor/genesis/bin
```

## 配置 `zetacored` systemd 服务

### 配置 Systemd Unit 文件

为本地安装的 systemd unit 创建路径：

```bash
sudo mkdir -p /usr/local/lib/systemd/system/
```

创建文件 `/usr/local/lib/systemd/system/zetacored.service`：

```bash
cat <<EOF | sudo tee /usr/local/lib/systemd/system/zetacored.service
[Unit]
Description=zetacored (running under cosmovisor)
After=multi-user.target
StartLimitIntervalSec=0
[Install]
WantedBy=multi-user.target
[Service]
WorkingDirectory=/home/zetachain/.zetacored/cosmovisor
Environment="DAEMON_HOME=/home/zetachain/.zetacored"
Environment="DAEMON_NAME=zetacored"
Environment="DAEMON_ALLOW_DOWNLOAD_BINARIES=true"
Environment="DAEMON_RESTART_AFTER_UPGRADE=true"
Environment="DAEMON_DATA_BACKUP_DIR=/home/zetachain/.zetacored"
Environment="UNSAFE_SKIP_BACKUP=true"
Type=simple
Restart=always
RestartSec=10
User=zetachain
LimitNOFILE=262144
ExecStart=cosmovisor run start --home /home/zetachain/.zetacored/ --log_format json
EOF
```

> 注意：在此示例中，我们设置了 `DAEMON_ALLOW_DOWNLOAD_BINARIES=true`。这指示 `cosmovisor` 在升级高度自动下载升级提案中指定的新二进制文件；如果 GitHub API 不可用，此操作会失败。建议启用此功能，但在升级前预加载并验证任何新的二进制文件以最小化风险。如果你已预加载二进制文件，则不会下载任何文件。参阅 [Cosmovisor 自动下载](https://docs.cosmos.network/v0.47/build/tooling/cosmovisor#auto-download)。

运行 `sudo systemctl daemon-reload` 加载服务。

运行 `sudo systemctl enable zetacored` 使服务在启动时自动启动。您应该会看到以下消息：

> Created symlink /etc/systemd/system/multi-user.target.wants/zetacored.service → /usr/local/lib/systemd/system/zetacored.service.

## 后续步骤

### 升级准备

关注 Discord 上的
[\#testnet-announcements](https://discord.com/channels/858516330432299008/1088945250124435486)
和/或
[\#mainnet-announcements](https://discord.com/channels/858516330432299008/1210655572798476338)
频道，以接收升级提案通知。

为准备升级，请从 GitHub release 下载新的二进制文件，并将其安装到 Cosmovisor 升级目录中。目录名称必须与升级名称匹配。升级名称并非 GitHub 上的 release 名称。可参考[治理升级提案](/reference/tools/proposals)页面便捷查看升级名称。以下是示例：

| 升级名称 | `zetacored` 路径                                            | git tag   |
| :----------- | :---------------------------------------------------------- | :-------- |
| `v26`        | `~/.zetacored/cosmovisor/upgrades/v26/bin/zetacored`        | `v26.0.0` |
| `v27`        | `~/.zetacored/cosmovisor/upgrades/v27/bin/zetacored`        | `v27.0.1` |

安装二进制文件后，你应该：

- 验证校验和是否正确
- 运行 `zetacored version` 以验证你确实可以运行下载的二进制文件

### 监控

在生产环境中，我们建议监控节点资源（CPU 负载、内存使用、磁盘使用和磁盘 IO）以发现任何性能下降。

`zetacored` 会生成日志，可用于监控错误和故障排除。如果你按上述说明将 `zetacored` 作为 systemd 服务安装，可以使用 `journalctl -eu zetacored` 查看日志。

### 指标 (Metrics)

Prometheus 默认启用，在端口 **26660** 上提供指标，可供 Prometheus 收集器使用。更多信息参阅 [Cosmos SDK Telemetry 文档](https://docs.cosmos.network/v0.50/learn/advanced/telemetry)。
