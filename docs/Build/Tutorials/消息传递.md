# 消息传递

| 标题 | 描述 |
| :- | :- |
| 消息传递 | 了解如何在 EVM 链上的合约之间进行跨链调用。 |

本教程演示如何使用 ZetaChain 的消息传递基础设施，在两个 EVM 链上的智能合约之间发送跨链消息。

与直接部署在 ZetaChain 上的通用应用（Universal App）不同，此方法允许你将全部智能合约逻辑保留在已连接的 EVM 链上。ZetaChain 仅负责在链之间转发消息载荷，无需在 ZetaChain 上额外部署智能合约。

> 💡 为何选择此模式？
> 与直接部署在 ZetaChain 上的通用应用不同，该模式允许你保留既有的链上业务逻辑，仅让 ZetaChain 承担跨链消息中继功能，无需在 ZetaChain 上重写任何逻辑。

完成本教程后，你将能够：

- 在两个 EVM 测试网（Base 与 Ethereum Sepolia）上部署消息智能合约。
- 为智能合约建立跨链通信链接。
- 从一个智能合约向另一个发送消息与代币价值。
- 跟踪从源链到目标链的跨链交易状态。

<div className="mt-8" style={{ width: "100%", height: "auto", "aspect-ratio": "16 / 9" }}>
  <iframe
    width="100%"
    height="100%"
    src="https://www.youtube.com/embed/UrAMdR807JQ"
    filename="YouTube video player"
    frameborder="0"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
    allowfullscreen
  ></iframe>
</div>

## 创建项目

使用 `messaging` 模板创建一个新项目：

```bash
npx zetachain new --project messaging
```

安装 TypeScript 和 Foundry 依赖：

```bash
cd messaging
yarn
forge soldeer update
```

编译合约：

```bash
forge build
```

将您的私钥保存在环境变量中，以便 shell 脚本可以读取它：

```bash
PRIVATE_KEY=...
```

## 消息合约

要启用跨链消息传递，您的合约必须继承自 ZetaChain 的 `Messaging` 基础合约，并实现一些必需的函数。

从 ZetaChain 标准合约包中导入 `Messaging.sol` 合约：

```solidity
import "@zetachain/standard-contracts/contracts/messaging/contracts/Messaging.sol";
```

继承 `Messaging`：

```solidity
contract Example is Messaging { ... }
```

在构造函数 (constructor) 中使用所需参数初始化合约：

```solidity
constructor(
    address payable _gateway,
    address owner,
    address _router
) Messaging(_gateway, owner, _router) {}
```

`Messaging` 基础合约提供了对网关 (Gateway) 和路由器 (Router) 的内置访问，并确保您的合约正确连接到 ZetaChain 的跨链消息传递系统。

您必须实现三个核心内部函数来处理消息传递和回退 (fallback)：

### onMessageReceive

当跨链消息成功到达目标链时，此函数会自动在目标链上被调用。

```solidity
function onMessageReceive(
    bytes memory data,
    bytes memory sender,
    uint256 amount,
    bytes memory asset
) internal override {
    //...
}
```

使用此函数解码消息并执行逻辑，例如更新状态、触发下游调用或转移接收到的代币价值。

### onMessageRevert

当目标合约的 `onMessageReceive` 失败（例如，由于无效的 calldata 或逻辑错误），则会触发此函数。

```solidity
function onMessageRevert(
    bytes memory data,
    bytes memory sender,
    uint256 amount,
    bytes memory asset
) internal override {
    //...
}
```

### onRevert

当消息在路由过程中（到达目标链之前）失败时调用。它在源链上执行。

```solidity
function onRevert(RevertContext calldata context)
    external
    payable
    override
    onlyGateway
{
    if (context.sender != router) revert Unauthorized();
    //...
}
```

您可以使用它来向用户退款、触发补偿逻辑或发出通知。

### 发送消息

要发起一个跨链消息，您的合约必须调用 EVM 网关上的 `depositAndCall` 函数。此函数负责将您的消息和可选的代币价值移交给 ZetaChain 的消息传递层以进行路由。

根据您是发送原生 Gas（如 ETH）还是 ERC-20 代币，您将使用以下两种 `depositAndCall` 形式之一。

如果您想发送带有 ETH 作为价值的消息：

```solidity
gateway.depositAndCall{value: msg.value}(
    router,
    message,
    revertOptions
);
```

如果您要发送支持的 ERC-20 代币：

```solidity
gateway.depositAndCall(
    router,
    amount,
    asset,
    message,
    revertOptions
);
```

`asset` 是被发送的 ERC-20 代币地址（必须是 ZetaChain 支持的）。

### 消息有效负载 (Payload) 中包含什么？

`message` 参数是一个单独的 `bytes` 字段。它经过 ABI 编码，并且必须遵循 ZetaChain 上的通用路由器 (Universal Router) 能够理解的结构。

```solidity
abi.encode(
    receiver,       // bytes: 目标链上的目标合约地址
    targetToken,    // address: 要转移到目标合约的代币的 ZRC-20 地址
    data,           // bytes: 消息有效负载 (例如, ABI 编码的 "hello")
    gasLimit,       // uint256: 转发用于在目标链上执行的 gas
    revertOptions   // struct: 定义失败时的操作
)
```

如果您要向 Ethereum Sepolia 上的合约发送字符串 `"hello"`，您可以这样编码：

```solidity
bytes memory data = abi.encode("hello");
bytes memory message = abi.encode(
    abi.encodePacked(receiver),  // 目标合约地址 (bytes 格式)
    targetToken,                 // 在目标链上转移的代币
    data,                        // ABI 编码的消息
    300_000,                     // Gas 限制
    revertOptions                // 指定回退行为的结构体
);
```

然后，此消息被传递给 `depositAndCall()` 并通过 ZetaChain 路由到目标链，在那里它被解码并传递到目标合约的 `onMessageReceive()` 中。

### 什么是通用路由器 (Universal Router)？

当您通过 `gateway.depositAndCall(...)` 发送跨链消息时，处理路由和在 ZetaChain 上执行的实际逻辑是在一个名为 **通用路由器 (Universal Router)** 的合约中实现的。

该合约运行在 ZetaChain 上，并充当 **所有跨链消息传递逻辑的入口点**。它负责：

- **解析** 从源链发送的 **消息有效负载**
- **交换代币** （如果需要）为：

  - 目标链的 **gas 代币**，以支付执行费用
  - 要交付给目标合约的 **目标代币**

- **转发消息** 和代币到目标合约
- **处理回退逻辑**，以防目标调用失败

所有使用 `Messaging` 基础合约的合约都共享同一个通用路由器。这种共享路由器简化了开发，确保了所有基于消息传递的应用具有一致的行为。

通用路由器确保您的合约只需要专注于发送编码后的有效负载，其他一切——从 gas 处理到代币转移再到交付机制——都为您管理好了。

您无需直接与通用路由器交互。只需编码您的消息，调用网关 (Gateway)，ZetaChain 将处理剩下的事情。

> 🔧 高级：如果您需要更多控制权，例如，自定义代币交换方式、路由到不同合约或以不同方式处理消息，您可以部署自己的路由器实例，并通过将其地址传递给 `Messaging` 构造函数来将您的合约指向它。

## 部署消息合约

部署到 Base Sepolia：

```bash
MESSAGING_BASE=$(./commands/index.ts deploy --rpc https://sepolia.base.org --private-key $PRIVATE_KEY | jq -r .contractAddress)
```

部署到 Ethereum Sepolia：

```bash
MESSAGING_ETHEREUM=$(./commands/index.ts deploy --rpc https://sepolia.drpc.org --private-key $PRIVATE_KEY | jq -r .contractAddress)
```

## 连接两个合约

在两个合约可以跨链通信之前，它们需要显式地相互信任。这可以防止恶意合约欺骗 (spoofing) 跨链消息。在此步骤中，您将在这两个已部署的消息合约之间建立双向链接。

每个合约都需要知道：

- 远程链上对应合约的地址
- 该远程链的链 ID

这是通过消息合约中的 `setConnected()` 函数完成的。只有当合约已将发送方注册为可信时，ZetaChain 的跨链基础设施才会向该合约传递消息。

⚠️ 如果您跳过此步骤或设置了错误的地址/链 ID，消息将在目标链上被拒绝。

```bash
./commands/index.ts connect \
  --contract $MESSAGING_BASE \
  --target-contract $MESSAGING_ETHEREUM \
  --rpc [https://sepolia.base.org](https://sepolia.base.org) \
  --target-chain-id 11155111 \
  --private-key $PRIVATE_KEY
```

```bash
./commands/index.ts connect \
  --contract $MESSAGING_ETHEREUM \
  --target-contract $MESSAGING_BASE \
  --rpc [https://sepolia.drpc.org](https://sepolia.drpc.org) \
  --target-chain-id 84532 \
  --private-key $PRIVATE_KEY
```

一旦两个方向都链接起来，合约就可以发送和接收消息了。

## 发送跨链消息

现在您的合约已经部署并连接，您可以从一个合约向另一个发送消息了。

本示例将字符串 "hello" 从 Base Sepolia 上的合约发送到 Ethereum Sepolia 上的合约，

```bash
./commands/index.ts message \
  --rpc [https://sepolia.base.org](https://sepolia.base.org) \
  --private-key $PRIVATE_KEY \
  --contract $MESSAGING_BASE \
  --target-contract $MESSAGING_ETHEREUM \
  --types string \
  --values hello \
  --target-token 0x05BA149A7bd6dC1F937fA9046A9e05C05f3b18b0 \
  --amount 0.005
```

| 标志 | 描述 |
| --- | --- |
| `--rpc https://sepolia.base.org` | **源链** (Base Sepolia) 的 RPC 端点。交易将发送到这里。 |
| `--private-key $PRIVATE_KEY` | 在源链上签署交易并提供资金的账户。它必须持有正在发送的代币。 |
| `--contract $MESSAGING_BASE` | 部署在源链上的消息合约地址。该合约发起跨链调用。 |
| `--target-contract $MESSAGING_ETHEREUM` | **目标链** 上的合约地址。这是消息的最终接收者。 |
| `--types string` | 您要发送的消息的 ABI 类型。这可以是单一类型（如 `string`）或元组（例如 `string,uint256`）。 |
| `--values hello` | 要编码并跨链发送的实际值，在本例中就是字符串 `"hello"`。 |
| `--target-token 0x...` | ZetaChain 上代表目标链代币的 ZRC20 代币地址。这告诉 ZetaChain 要将什么资产转移到目标合约。 |
| `--amount 0.005` | 发送的代币总额。其中一部分用于支付目标链上的 gas 费用；其余部分将转移到目标合约。 |

### 如何处理金额 (Amount)

当您使用 `--amount` 发送跨链消息时，您不仅是在转移代币，还是在为目标链预付 gas 费用。幕后发生的事情如下：

1. 您在源链上 **提供代币**（例如 Base ETH）。这可以是原生 gas（如 ETH）或任何支持的 ERC-20。
2. 您通过 `--target-token` 指定一个 **目标代币**，它指向代表您想在目标链上交付的代币的 ZRC-20（例如 Ethereum ETH）。
3. 在 ZetaChain 上：

    - **所提供金额的一部分** 会被自动交换为目标链 **gas 代币** 的 ZRC-20 版本（在本例中为 Ethereum ETH）。这用于支付消息在目标链上的 **执行成本**。
    - **剩余金额** 被交换为 **目标代币**（可能与 gas 代币相同）并转发到目标合约。

这使得系统完全自动化：您无需持有或获取目标链的原生代币即可与其交互。

```json
{
  "contractAddress": "0xee2E8dfefd723e879CAa30A1DaD94046Fa3D24D4",
  "targetContract": "0x7c9BbA0630c9452F726bc15D0a73cdF769438efE",
  "targetToken": "0x05BA149A7bd6dC1F937fA9046A9e05C05f3b18b0",
  "message": "0x0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000568656c6c6f000000000000000000000000000000000000000000000000000000",
  "transactionHash": "0x939e230dd504efdf1fce31202a5980b4d0376430ddf535d080666256353c02c3",
  "amount": "0.005"
}
```

## 跟踪跨链交易

使用上一步中的交易哈希来查询其跨链状态：

```bash
npx zetachain query cctx --hash 0x939e230dd504efdf1fce31202a5980b4d0376430ddf535d080666256353c02c3
```

```text
84532 → 7001 ✅ OutboundMined
CCTX:     0xd88d92d0b9b0a2fde416bf6383e430b51de48114b0b03e7cc34e7f8d8df15cb7
Tx Hash:  0x939e230dd504efdf1fce31202a5980b4d0376430ddf535d080666256353c02c3 (on chain 84532)
Tx Hash:  0x8c368f6a3cfc55950b5d2b0d98c63d1904a79300490ec7d1c258505f372054e3 (on chain 7001)
Sender:   0xee2E8dfefd723e879CAa30A1DaD94046Fa3D24D4
Receiver: 0x5BD35697D4a62DE429247cbBDCc5c47F70477775
Message:  00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000005ba149a7bd6dc1f937fa9046a9e05c05f3b18b000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000147c9bba0630c9452f726bc15d0a73cdf769438efe00000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000568656c6c6f000000000000000000000000000000000000000000000000000000000000000000000000000000ee2e8dfefd723e879caa30a1dad94046fa3d24d40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000f42400000000000000000000000000000000000000000000000000000000000000000
Amount:   5000000000000000 Gas tokens

7001 → 11155111 ✅ OutboundMined
CCTX:     0x8952c9f95dfb5673a9fbfa2196842b750f5530f4931a55088b1276599328fd64
Tx Hash:  0xd88d92d0b9b0a2fde416bf6383e430b51de48114b0b03e7cc34e7f8d8df15cb7 (on chain 7001)
Tx Hash:  0xf30e4414087e8b5c81e257e8a97ac9105dde37cbbd6bb33a1691c4a30585507e (on chain 11155111)
Sender:   0x5BD35697D4a62DE429247cbBDCc5c47F70477775
Receiver: 0x7c9BbA0630c9452F726bc15D0a73cdF769438efE
Message:  00000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000009ad718280b1cf00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000014a34000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000568656c6c6f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014ee2e8dfefd723e879caa30a1dad94046fa3d24d40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
Amount:   1074034700777807 Gas tokens
```

这确认了消息已成功从 Base Sepolia 通过 ZetaChain 转移到 Ethereum Sepolia。

您可以在 Etherscan 上验证目标链交易：

[在 Etherscan 查看该交易](https://sepolia.etherscan.io/tx/0xf30e4414087e8b5c81e257e8a97ac9105dde37cbbd6bb33a1691c4a30585507e)

